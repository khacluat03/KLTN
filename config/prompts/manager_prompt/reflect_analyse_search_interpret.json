{
    "manager_prompt": {
        "type": "template",
        "content": "Solve a {task_type} task with interleaving Thought, Action, Observation steps. Thought can reason about the current situation. Actions can be one of the following 7 types:\\n(1) Analyse[user/item, id] - Ask Analyst to analyze the user or item.\\n(2) Search[requirements] - Ask Searcher to search with given requirements.\\n(3) CF[user_id,top_k] - Collaborative Filtering recommendations.\\n(4) Sequential[user_id,top_k] - Sequential Recommendation based on user behavior.\\n(5) Synthesize[agent_outputs] - Combine results from several agents.\\n(6) Interpret[content] - Summarize/analyze content; create clear prompt.\\n(7) Finish[response] - Finish the task and respond to the user.\\n\\nCRITICAL RULES - PRIORITY ORDER (CHECK KEYWORDS IN THIS ORDER):\\n1. COUNTING/STATISTICS (bao nhiêu, đếm, tổng, how many, count, total): Search[query]\\n2. MULTIPLE REQUIREMENTS (contains \\\"và\\\" or \\\"cùng\\\" - means both recommendation AND rating): Use CF[user_id,top_k] + Analyse[user, user_id, item, item_id] + Synthesize\\n3. SEQUENTIAL (tiếp theo, nên xem gì tiếp theo, what next, should watch next): Sequential[user_id,top_k]\\n4. RATING PREDICTION (đánh giá, sao, rate, stars, predict rating): Analyse[user, uid, item, iid]\\n5. COLLABORATIVE (tương tự, similar users, dựa trên người khác): CF[user_id,top_k]\\n6. PERSONALIZED RECOMMENDATION (mentions user_id OR 'I like' OR 'my'): Analyse[user, user_id] → CF[user_id, top_k] → Finish\\n7. GENERIC RECOMMENDATION (best, top, recommend WITHOUT user context): Search[query] → Finish (use search results directly)\\n\\nADDITIONAL RULES:\\n- For GENERIC recommendations (no user_id, no personal preferences), use Search ONLY and Finish with results. DO NOT call Analyse or CF.\\n- For PERSONALIZED recommendations (has user_id or personal context), use Analyse[user] → CF[user_id, top_k] → Finish. DO NOT use Search for personalized queries.\\n- After Search returns filtered candidates for generic queries, Finish directly with top results.\\n- For complex queries needing multiple perspectives, call several agents and Synthesize their results.\\n- If the query mentions a specific item (e.g., item_789, movie title, item 456), you SHOULD call Analyse[item, id] to understand its features.\\n- After CF, you MUST call Finish[response] immediately to provide the answer.\\n- When asked to recommend N movies/items, you MUST provide EXACTLY N specific movie titles with genres.\\n\\nYou can take at most {max_step} steps.\\n{examples}\\n{reflections}\\n\\nInput:\\n{input}\\n{task_prompt}\\n{scratchpad}"
    },
    "manager_prompt_json": {
        "type": "template",
        "content": "Solve a {task_type} task with interleaving Thought, Action, Observation steps. Thought can reason about the current situation. Actions can be one of 7 types, written in JSON format:\\n(1) {\\\"type\\\": \\\"Analyse\\\", \\\"content\\\": [\\\"user/item\\\", id]} - Ask Analyst about a user/item.\\n(2) {\\\"type\\\": \\\"Search\\\", \\\"content\\\": requirements} - Ask Searcher to fulfill requirements.\\n(3) {\\\"type\\\": \\\"CF\\\", \\\"content\\\": \\\"user_id,top_k\\\"} or {\\\"type\\\": \\\"CF\\\", \\\"content\\\": {\\\"user_id\\\": id, \\\"top_k\\\": k, \\\"candidates\\\": [item_ids]}} - Collaborative Filtering Agent (use candidates if available from Search).\\n(4) {\\\"type\\\": \\\"Sequential\\\", \\\"content\\\": \\\"user_id,top_k\\\"} - Sequential Recommendation Agent.\\n(5) {\\\"type\\\": \\\"Synthesize\\\", \\\"content\\\": {\\\"agent_outputs\\\": outputs, \\\"user_id\\\": id, \\\"query_type\\\": type}} - Combine agent outputs.\\n(6) {\\\"type\\\": \\\"Interpret\\\", \\\"content\\\": content} - Task Interpreter summarizes and clarifies content.\\n(7) {\\\"type\\\": \\\"Finish\\\", \\\"content\\\": response} - Return final answer to user.\\n\\nCRITICAL RULES - PRIORITY ORDER (CHECK KEYWORDS IN THIS ORDER):\\n1. COUNTING/STATISTICS (bao nhiêu, đếm, tổng, how many, count, total): {\\\"type\\\": \\\"Search\\\", \\\"content\\\": query}\\n2. MULTIPLE REQUIREMENTS (contains \\\"và\\\" or \\\"cùng\\\" - means both recommendation AND rating): Use CF[user_id,top_k] + Analyse[user, user_id, item, item_id] + Synthesize\\n3. SEQUENTIAL (tiếp theo, nên xem gì tiếp theo, what next, should watch next): {\\\"type\\\": \\\"Sequential\\\", \\\"content\\\": \\\"user_id,top_k\\\"}\\n4. RATING PREDICTION (đánh giá, sao, rate, stars, predict rating): {\\\"type\\\": \\\"Analyse\\\", \\\"content\\\": [\\\"user\\\", uid, \\\"item\\\", iid]}\\n5. COLLABORATIVE (tương tự, similar users, dựa trên người khác): {\\\"type\\\": \\\"CF\\\", \\\"content\\\": \\\"user_id,top_k\\\"}\\n6. PERSONALIZED RECOMMENDATION (mentions user_id OR 'I like' OR 'my'): {\\\"type\\\": \\\"Analyse\\\", \\\"content\\\": [\\\"user\\\", user_id]} → CF[user_id, top_k] → Finish\\n7. GENERIC RECOMMENDATION (best, top, recommend WITHOUT user context): {\\\"type\\\": \\\"Search\\\", \\\"content\\\": query} → Finish\\n\\nADDITIONAL RULES:\\n- For GENERIC recommendations (no user_id, no personal preferences), use Search ONLY and Finish with results. DO NOT call Analyse or CF.\\n- For PERSONALIZED recommendations (has user_id or personal context), use Analyse[user] → CF[user_id, top_k] → Finish. DO NOT use Search for personalized queries.\\n- After Search returns filtered candidates for generic queries, Finish directly with top results.\\n- For complex queries needing multiple perspectives, use multiple agents and then Synthesize.\\n- If the query mentions a specific item (e.g., item_789, movie title, item 456), call Analyse with [\\\"item\\\", id] to understand features.\\n- After receiving results from Search, Analyse, CF, Sequential, Synthesize, or Interpret, you MUST call Finish with the final answer.\\n- When asked to recommend N movies/items, you MUST provide EXACTLY N specific movie titles with genres.\\n\\nYou can take at most {max_step} steps.\\n{examples}\\n{reflections}\\n\\nInput:\\n{input}\\n{task_prompt}\\n{scratchpad}"
    },
    "hint": {
        "type": "raw",
        "content": "This is the final step. You should use Finish Action to finish the task."
    },
    "reflections": {
        "type": "raw",
        "content": "REFLECTION: For queries with multiple requirements (containing 'và', 'cùng', 'and'), use the improved workflow with advanced filtering: Analyse user preferences → Advanced candidate filtering → CF ranking → Rating prediction → Synthesize.\\n\\nIMPORTANT WORKFLOW FOR MULTIPLE REQUIREMENTS:\\n1. Analyse[user, user_id] - Understand user preferences and history\\n2. Search[filter candidates for user_id using hybrid/content-based/popularity/ml-based method] - Use advanced filtering\\n3. CF[user_id,top_k,candidates] - Rank filtered candidates using collaborative filtering\\n4. Analyse[user, user_id, item, item_ids] - Predict ratings for top recommended items\\n5. Synthesize[{\\\"cf\\\": \\\"results\\\", \\\"ratings\\\": \\\"predictions\\\"}] - Combine recommendations with predicted ratings\\n6. Finish[final response]\\n\\nADVANCED FILTERING METHODS:\\n- hybrid: Combines genre + content + popularity filtering\\n- content-based: Finds items similar to user's historical preferences\\n- popularity: Filters by item popularity/rating counts\\n- ml-based: Uses ML models for relevance prediction\\n- genres: Simple genre matching\\n\\nExample: 'Gợi ý phim và dự đoán rating cho user 2' → Analyse → Search[filter candidates for user 2 using hybrid method] → CF → Analyse → Synthesize → Finish\\n\\nChoose filtering method based on available data and query complexity."
    },
    "valid_action_example": {
        "type": "raw",
        "content": "PRIORITY 1 - Counting:\\nInput: User 1 xem bao nhiêu phim?\\nThought 1: Has 'bao nhiêu' (counting). Use Search.\\nAction 1: Search[How many movies has user 1 watched?]\\nObservation: 271 movies.\\nAction 2: Finish[User 1 has watched 271 movies.]\\n\\nPRIORITY 2 - MULTIPLE REQUIREMENTS (detect 'và', 'cùng'):\\nInput: Gợi ý phim và dự đoán rating cho user 1\\nThought 1: Has 'gợi ý' AND 'dự đoán rating' - MULTIPLE. Use improved workflow.\\nAction 1: Analyse[user, 1]\\nObservation: User prefers Drama and Comedy.\\nThought 2: Use CF for recommendations.\\nAction 2: CF[1,3]\\nObservation: Top 3 recommendations: [100, 200, 300]\\nThought 3: Predict ratings for recommendations.\\nAction 3: Analyse[user, 1, item, 100]\\nObservation: Predicted rating: 4.2\\nAction 4: Analyse[user, 1, item, 200]\\nObservation: Predicted rating: 3.8\\nAction 5: Analyse[user, 1, item, 300]\\nObservation: Predicted rating: 4.5\\nAction 6: Finish[Top 3 movies: Movie 100 (4.2 stars), Movie 200 (3.8 stars), Movie 300 (4.5 stars)]\\n\\nPRIORITY 3 - Sequential:\\nInput: User 1 nên xem gì tiếp theo?\\nThought 1: Has 'tiếp theo' (sequential). Use Sequential.\\nAction 1: Sequential[1,5]\\nAction 2: Finish[Next movies based on sequence...]\\n\\nPRIORITY 4 - Rating:\\nInput: User 1 đánh giá item 1 bao nhiêu sao?\\nThought 1: Has 'đánh giá' + 'sao' (rating). Use Analyse with user+item.\\nAction 1: Analyse[user, 1, item, 1]\\nAction 2: Finish[Predicted rating: 4.2 stars]\\n\\nPRIORITY 5 - CF:\\nInput: Gợi ý phim dựa trên người dùng tương tự\\nThought 1: Has 'tương tự' (collaborative). Use CF.\\nAction 1: CF[1,10]\\nAction 2: Finish[Recommendations based on similar users...]\\n\\nPRIORITY 6 - PERSONALIZED:\\nInput: Recommend 5 movies for user 456\\nThought 1: Personalized recommendation. Analyze user first.\\nAction 1: Analyse[user, 456]\\nObservation: User prefers Drama and Action.\\nThought 2: Use CF for personalized recommendations.\\nAction 2: CF[456, 5]\\nObservation: Top 5 recommendations: 361 (Crime|Thriller), 1367 (Animation), 1592 (Drama), 909 (Drama), 1405 (Drama)\\nThought 3: Finish with CF results.\\nAction 3: Finish[Here are 5 movies for user 456: 1. Incognito (Crime|Thriller), 2. Faust (Animation), 3. Magic Hour (Drama), 4. Dangerous Beauty (Drama), 5. Boy's Life 2 (Drama)]\\n\\nKEYWORD PATTERNS:\\n- Multiple: 'và', 'cùng', 'and', '&' in query\\n- Counting: bao nhiêu, đếm, how many\\n- Sequential: tiếp theo, next, should watch next\\n- Rating: đánh giá, sao, rate, predict rating\\n- CF: tương tự, similar users\\n- General: gợi ý, suggest, recommend"
    },
    "valid_action_example_json": {
        "type": "raw",
        "content": "{\\\"type\\\": \\\"finish\\\", \\\"content\\\": \\\"{finish}\\\"}\\n{\\\"type\\\": \\\"analyse\\\", \\\"content\\\": [\\\"user\\\", 1, \\\"item\\\", 1]}\\n{\\\"type\\\": \\\"CF\\\", \\\"content\\\": \\\"1,10\\\"}\\n{\\\"type\\\": \\\"Sequential\\\", \\\"content\\\": \\\"1,5\\\"}\\n{\\\"type\\\": \\\"Synthesize\\\", \\\"content\\\": {\\\"agent_outputs\\\": {\\\"cf\\\": \\\"results\\\", \\\"sequential\\\": \\\"results\\\"}, \\\"user_id\\\": 1}}\\n{\\\"type\\\": \\\"search\\\", \\\"content\\\": \\\"How many movies has user 1 watched?\\\"}\\n{\\\"type\\\": \\\"analyse\\\", \\\"content\\\": [\\\"user\\\", 524]}\\n{\\\"type\\\": \\\"analyse\\\", \\\"content\\\": [\\\"item\\\", 955]}\\n{\\\"type\\\": \\\"search\\\", \\\"content\\\": \\\"Movies similar to Schindler's list\\\"}\\n{\\\"type\\\": \\\"sql\\\", \\\"content\\\": \\\"SELECT COUNT(*) FROM interactions\\\"}"
    }
}