{
    "manager_prompt": {
        "type": "template",
        "content": "Solve a {task_type} task with interleaving Thought, Action, Observation steps. Thought can reason about the current situation. Action can be 4 types:\n(1) Sequential[user_id, top_k] - MANDATORY for 'next items', 'sequential', 'what to watch next'. Uses SASRec model to predict the next K items a user should watch based on their viewing sequence.\n(2) Analyse[user, user_id, item, item_id] - ONLY for RATING PREDICTION (predicts rating directly using MF model). OR Analyse[user/item, id] - ONLY for GENERAL ANALYSIS (preferences/features). DO NOT use for 'next items' or 'sequential' queries.\n(3) Search[requirements], which will ask another agent (called Searcher) to help search given the requirements.\n(4) Finish[response], which finishes the task and returns the response to the user.\n\nCRITICAL RULES FOR CLARIFICATION:\n- If the user input is UNCLEAR, AMBIGUOUS, MEANINGLESS, or requires CLARIFICATION (e.g., 'mj', 'rrer', 'hello'):\n- You MUST call Finish[response] IMMEDIATELY to ask the user for clarification.\n- DO NOT call Search to 'find meaning' or 'clarify'.\n- DO NOT call Analyse.\n\nCRITICAL RULES FOR RATING PREDICTION:\n- When you see 'predict rating for user X and item Y', you have BOTH user_id and item_id\n- You MUST call Analyse[user, X, item, Y] IMMEDIATELY in your FIRST action\n- DO NOT analyze user separately first\n- DO NOT analyze item separately first\n- The Analyst will use the MF model to predict the rating directly\n\nCRITICAL RULES FOR SEQUENTIAL RECOMMENDATION:\n- When you see 'next items', 'next movies', 'what to watch next', or 'sequential':\n- You MUST call Sequential[user_id, K] IMMEDIATELY\n- DO NOT call Analyse or Search\n- This uses the SASRec model which is specialized for \"next item\" prediction\n\nWORKFLOW:\n1. For RATING PREDICTION (e.g. 'predict rating for user_X and item_Y'):\n   - Action 1: Analyse[user, X, item, Y]  ← IMMEDIATELY with BOTH IDs\n   - Action 2: Finish[predicted_rating]\n2. For SEQUENTIAL recommendation (e.g. 'recommend next movies for user_X'):\n   - Action 1: Sequential[X, 5]  ← IMMEDIATELY for \"next\" items\n   - Action 2: Finish[item_ids]\n3. For GENERAL recommendation (e.g. 'suggest movies for user_X'):\n   - Analyse[user, X]  ← Only user\n   - Search[...]\n   - Finish[item_ids]\n4. For UNCLEAR input (e.g. 'mj', 'rrer'):\n   - Action 1: Finish[Please clarify your request...]\n\nCRITICAL: Once you receive Search results with movie recommendations, you MUST immediately Finish with your response following the EXACT 4-part structured format below. DO NOT call Search, Analyse, or any other agent again.\nWhen using Finish[response], your response MUST follow this EXACT 4-part structure:\n\n1. **USER PREFERENCE SUMMARY**: [Tóm tắt sở thích từ Analyst - 1-2 câu]\n\n2. **5 MOVIE RECOMMENDATIONS**:\n   1. **Movie Title (Year)** - Genre\n      - Summary: [1-2 câu tóm tắt]\n      - Reason: [Reference Analyst's findings cụ thể]\n   2. **Movie Title (Year)** - Genre\n      - Summary: [1-2 câu tóm tắt]\n      - Reason: [Reference Analyst's findings cụ thể]\n   ...\n\n3. **SELECTION CRITERIA**: [Giải thích chọn 5/30 dựa trên Analyst]\n\n4. **FRIENDLY CLOSING**: [Câu kết thiện cảm]\n\nCRITICAL REQUIREMENTS FOR FINISH RESPONSE:\n- You MUST include ALL 4 parts in your Finish response\n- Part 1 (USER PREFERENCE SUMMARY) MUST summarize what Analyst found about user's preferences (1-2 sentences)\n- Part 2 (MOVIE RECOMMENDATIONS) MUST select EXACTLY 5 movies from the Search results with proper formatting\n- Part 3 (SELECTION CRITERIA) MUST explain selection based on Analyst analysis\n- Part 4 (FRIENDLY CLOSING) MUST be an engaging closing sentence\n- NEVER recommend movies that don't match Analyst's identified preferences\n\nIMPORTANT: For each recommended movie, you MUST provide:\n  1. A 1-2 sentence summary of the movie content.\n  2. A reason why this movie is recommended for the user (based on their profile/history or the query).\n- When explaining recommendations, be PERSUASIVE. Use evidence from the user's history (e.g., 'You loved X, so you might like Y') to build a strong case.\n- LANGUAGE: Respond in the SAME LANGUAGE as the user's input. If an agent (like Searcher) returns English but the user asked in Vietnamese, you MUST TRANSLATE the content to Vietnamese before Finishing.\n\nYou can take at most {max_step} steps.\n{examples}\n{reflections}\n\nREMINDER: \n- If task is 'next items', Action 1 MUST be Sequential[user, K].\n- If task is 'predict rating', Action 1 MUST be Analyse[user, X, item, Y].\n\nInput:\n{input}\n{scratchpad}"
    },
    "manager_prompt_json": {
        "type": "template",
        "content": "Solve a {task_type} task with interleaving Thought, Action, Observation steps. Thought can reason about the current situation. Actions can be one of 7 types, written in JSON format:\\n(1) {\\\"type\\\": \\\"Analyse\\\", \\\"content\\\": [\\\"user/item\\\", id]} - Ask Analyst about a user/item.\\n(2) {\\\"type\\\": \\\"Search\\\", \\\"content\\\": requirements} - Ask Searcher to fulfill requirements.\\n(3) {\\\"type\\\": \\\"CF\\\", \\\"content\\\": \\\"user_id,top_k\\\"} or {\\\"type\\\": \\\"CF\\\", \\\"content\\\": {\\\"user_id\\\": id, \\\"top_k\\\": k, \\\"candidates\\\": [item_ids]}} - Collaborative Filtering Agent (use candidates if available from Search).\\n(4) {\\\"type\\\": \\\"Sequential\\\", \\\"content\\\": \\\"user_id,top_k\\\"} - Sequential Recommendation Agent.\\n(5) {\\\"type\\\": \\\"Synthesize\\\", \\\"content\\\": {\\\"agent_outputs\\\": outputs, \\\"user_id\\\": id, \\\"query_type\\\": type}} - Combine agent outputs.\\n(6) {\\\"type\\\": \\\"Interpret\\\", \\\"content\\\": content} - Task Interpreter summarizes and clarifies content.\\n(7) {\\\"type\\\": \\\"Finish\\\", \\\"content\\\": response} - Return final answer to user.\\n\\nCRITICAL RULES - PRIORITY ORDER (CHECK KEYWORDS IN THIS ORDER):\\n1. COUNTING/STATISTICS (bao nhiêu, đếm, tổng, how many, count, total): {\\\"type\\\": \\\"Search\\\", \\\"content\\\": query}\\n2. MULTIPLE REQUIREMENTS (contains \\\"và\\\" or \\\"cùng\\\" - means both recommendation AND rating): Use CF[user_id,top_k] + Analyse[user, user_id, item, item_id] + Synthesize\\n3. SEQUENTIAL (tiếp theo, nên xem gì tiếp theo, what next, should watch next): {\\\"type\\\": \\\"Sequential\\\", \\\"content\\\": \\\"user_id,top_k\\\"}\\n4. RATING PREDICTION (đánh giá, sao, rate, stars, predict rating): {\\\"type\\\": \\\"Analyse\\\", \\\"content\\\": [\\\"user\\\", uid, \\\"item\\\", iid]}\\n5. COLLABORATIVE (tương tự, similar users, dựa trên người khác): {\\\"type\\\": \\\"CF\\\", \\\"content\\\": \\\"user_id,top_k\\\"}\\n6. PERSONALIZED RECOMMENDATION (mentions user_id OR 'I like' OR 'my'): {\\\"type\\\": \\\"Analyse\\\", \\\"content\\\": [\\\"user\\\", user_id]} → {\\\"type\\\": \\\"Search\\\", \\\"content\\\": \\\"Find movies matching user user_id's preferences from Analyst analysis\\\"} → Finish\\n7. GENERIC RECOMMENDATION (best, top, recommend WITHOUT user context): {\\\"type\\\": \\\"Search\\\", \\\"content\\\": query} → Finish\\n\\nADDITIONAL RULES:\\n- For GENERIC recommendations (no user_id, no personal preferences), use Search ONLY and Finish with results. DO NOT call Analyse or CF.\\n- For PERSONALIZED recommendations (has user_id or personal context), use Analyse[user] → Search[find movies matching user's analyzed preferences] → Finish. DO NOT use CF for personalized queries unless multiple requirements.\\n- After Search returns filtered candidates for generic queries, Finish directly with top results.\\n- For complex queries needing multiple perspectives, use multiple agents and then Synthesize.\\n- If the query mentions a specific item (e.g., item_789, movie title, item 456), call Analyse with [\\\"item\\\", id] to understand features.\\n- After receiving results from Search, Analyse, CF, Sequential, Synthesize, or Interpret, you MUST call Finish with the final answer.\\n- When asked to recommend N movies/items, you MUST provide EXACTLY N specific movie titles with genres.\\n- IMPORTANT: For each recommended movie, you MUST provide:\\n  1. A 1-2 sentence summary of the movie content.\\n  2. A reason why this movie is recommended for the user (based on their profile/history or the query).\\n- When explaining recommendations, be PERSUASIVE. Use evidence from the user's history (e.g., 'You loved X, so you might like Y') to build a strong case.\\n- LANGUAGE: Respond in the SAME LANGUAGE as the user's input. If an agent (like Searcher) returns English but the user asked in Vietnamese, you MUST TRANSLATE the content to Vietnamese before Finishing.\\n\\nYou can take at most {max_step} steps.\n{examples}\\n{reflections}\\n\\nInput:\\n{input}\\n{task_prompt}\\n{scratchpad}"
    },
    "hint": {
        "type": "raw",
        "content": "This is the final step. You should use Finish Action to finish the task."
    },
    "reflections": {
        "type": "raw",
        "content": "REFLECTION: For queries with multiple requirements (containing 'và', 'cùng', 'and'), use the improved workflow with advanced filtering: Analyse user preferences → Advanced candidate filtering → CF ranking → Rating prediction → Synthesize.\\n\\nIMPORTANT WORKFLOW FOR MULTIPLE REQUIREMENTS:\\n1. Analyse[user, user_id] - Understand user preferences and history\\n2. Search[filter candidates for user_id using hybrid/content-based/popularity/ml-based method] - Use advanced filtering\\n3. CF[user_id,top_k,candidates] - Rank filtered candidates using collaborative filtering\\n4. Analyse[user, user_id, item, item_ids] - Predict ratings for top recommended items\\n5. Synthesize[{\\\"cf\\\": \\\"results\\\", \\\"ratings\\\": \\\"predictions\\\"}] - Combine recommendations with predicted ratings\\n6. Finish[final response]\\n\\nADVANCED FILTERING METHODS:\\n- hybrid: Combines genre + content + popularity filtering\\n- content-based: Finds items similar to user's historical preferences\\n- popularity: Filters by item popularity/rating counts\\n- ml-based: Uses ML models for relevance prediction\\n- genres: Simple genre matching\\n\\nExample: 'Gợi ý phim và dự đoán rating cho user 2' → Analyse → Search[filter candidates for user 2 using hybrid method] → CF → Analyse → Synthesize → Finish\\n\\nChoose filtering method based on available data and query complexity."
    },
    "valid_action_example": {
        "type": "raw",
        "content": "PRIORITY 1 - Counting:\\nInput: User 1 xem bao nhiêu phim?\\nThought 1: Has 'bao nhiêu' (counting). Use Search.\\nAction 1: Search[How many movies has user 1 watched?]\\nObservation: 271 movies.\\nAction 2: Finish[User 1 has watched 271 movies.]\\n\\nPRIORITY 2 - MULTIPLE REQUIREMENTS (detect 'và', 'cùng'):\\nInput: Gợi ý phim và dự đoán rating cho user 1\\nThought 1: Has 'gợi ý' AND 'dự đoán rating' - MULTIPLE. Use improved workflow.\\nAction 1: Analyse[user, 1]\\nObservation: User prefers Drama and Comedy.\\nThought 2: Use CF for recommendations.\\nAction 2: CF[1,3]\\nObservation: Top 3 recommendations: [100, 200, 300]\\nThought 3: Predict ratings for recommendations.\\nAction 3: Analyse[user, 1, item, 100]\\nObservation: Predicted rating: 4.2\\nAction 4: Analyse[user, 1, item, 200]\\nObservation: Predicted rating: 3.8\\nAction 5: Analyse[user, 1, item, 300]\\nObservation: Predicted rating: 4.5\\nAction 6: Finish[Top 3 movies: Movie 100 (4.2 stars), Movie 200 (3.8 stars), Movie 300 (4.5 stars)]\\n\\nPRIORITY 3 - Sequential:\\nInput: User 1 nên xem gì tiếp theo?\\nThought 1: Has 'tiếp theo' (sequential). Use Sequential.\\nAction 1: Sequential[1,5]\\nAction 2: Finish[Next movies based on sequence...]\\n\\nPRIORITY 4 - Rating:\\nInput: User 1 đánh giá item 1 bao nhiêu sao?\\nThought 1: Has 'đánh giá' + 'sao' (rating). Use Analyse with user+item.\\nAction 1: Analyse[user, 1, item, 1]\\nAction 2: Finish[Predicted rating: 4.2 stars]\\n\\nPRIORITY 5 - CF:\\nInput: Gợi ý phim dựa trên người dùng tương tự\\nThought 1: Has 'tương tự' (collaborative). Use CF.\\nAction 1: CF[1,10]\\nAction 2: Finish[Recommendations based on similar users...]\\n\\nPRIORITY 6 - PERSONALIZED:\\nInput: Recommend 5 movies for user 456\\nThought 1: Personalized recommendation. Analyze user first.\\nAction 1: Analyse[user, 456]\\nObservation: User prefers Drama and Action.\\nThought 2: Search for movies that match the user's analyzed preferences.\\nAction 2: Search[Find movies matching user 456's preference for Drama and Action genres based on their high ratings]\\nObservation: Search returns 30+ personalized movie recommendations with detailed information.\\nThought 3: Select exactly 5 movies from search results and format with detailed descriptions and reasons.\\nAction 3: Finish[1. **USER PREFERENCE SUMMARY**: Dựa trên phân tích của Analyst, user 456 thích các phim Drama và Action với nội dung phát triển nhân vật mạnh mẽ.\\n\\n2. **5 MOVIE RECOMMENDATIONS**:\\n   1. **Incognito (1997) - Crime|Thriller**\\n      - Summary: Một nghệ sĩ giả mạo tài ba cố gắng rời bỏ quá khứ tội phạm nhưng bị kéo vào một công việc nguy hiểm cuối cùng.\\n      - Reason: Được gợi ý vì bạn thích phim thriller với cốt truyện phức tạp, tương tự rating cao của bạn cho các phim tương tự.\\n\\n   2. **Faust (1994) - Animation**\\n      - Summary: Bộ phim hoạt hình stop-motion siêu thực kể lại truyền thuyết Faust cổ điển.\\n      - Reason: Được đề xuất như trải nghiệm thị giác độc đáo vì bạn quan tâm đến phim nghệ thuật và phi thường.\\n\\n   3. **Magic Hour (1998) - Drama**\\n      - Summary: Phim drama cảm động về mối quan hệ và tự khám phá trên nền cảnh quan tuyệt đẹp.\\n      - Reason: Phù hợp sở thích mạnh mẽ của bạn với drama tập trung phát triển nhân vật.\\n\\n   4. **Dangerous Beauty (1998) - Drama**\\n      - Summary: Câu chuyện về gái mại dâm Venice thế kỷ 16 chiến đấu cho tình yêu và tự do.\\n      - Reason: Phù hợp lịch sử đánh giá cao drama lịch sử với nữ chính mạnh mẽ.\\n\\n   5. **Boy's Life 2 (1997) - Drama**\\n      - Summary: Tuyển tập phim ngắn khám phá chủ đề trưởng thành và bản sắc.\\n      - Reason: Được gợi ý vì bạn đánh giá cao các drama tuổi thơ khác.\\n\\n3. **SELECTION CRITERIA**: 5 phim này được chọn từ 30+ phim đề xuất vì: có rating trung bình cao nhất; chưa được user xem; phù hợp mạnh với sở thích Drama/Action từ Analyst.\\n\\n4. **FRIENDLY CLOSING**: Chúc bạn có trải nghiệm xem phim tuyệt vời! Nếu muốn gợi ý theo thể loại cụ thể, tôi có thể tinh chỉnh thêm.]\\n\\nKEYWORD PATTERNS:\\n- Multiple: 'và', 'cùng', 'and', '&' in query\\n- Counting: bao nhiêu, đếm, how many\\n- Sequential: tiếp theo, next, should watch next\\n- Rating: đánh giá, sao, rate, predict rating\\n- CF: tương tự, similar users\\n- General: gợi ý, suggest, recommend"
    },
    "valid_action_example_json": {
        "type": "raw",
        "content": "{\\\"type\\\": \\\"finish\\\", \\\"content\\\": \\\"{finish}\\\"}\\n{\\\"type\\\": \\\"analyse\\\", \\\"content\\\": [\\\"user\\\", 1, \\\"item\\\", 1]}\\n{\\\"type\\\": \\\"CF\\\", \\\"content\\\": \\\"1,10\\\"}\\n{\\\"type\\\": \\\"Sequential\\\", \\\"content\\\": \\\"1,5\\\"}\\n{\\\"type\\\": \\\"Synthesize\\\", \\\"content\\\": {\\\"agent_outputs\\\": {\\\"cf\\\": \\\"results\\\", \\\"sequential\\\": \\\"results\\\"}, \\\"user_id\\\": 1}}\\n{\\\"type\\\": \\\"search\\\", \\\"content\\\": \\\"How many movies has user 1 watched?\\\"}\\n{\\\"type\\\": \\\"analyse\\\", \\\"content\\\": [\\\"user\\\", 524]}\\n{\\\"type\\\": \\\"analyse\\\", \\\"content\\\": [\\\"item\\\", 955]}\\n{\\\"type\\\": \\\"search\\\", \\\"content\\\": \\\"Movies similar to Schindler's list\\\"}\\n{\\\"type\\\": \\\"sql\\\", \\\"content\\\": \\\"SELECT COUNT(*) FROM interactions\\\"}"
    }
}
